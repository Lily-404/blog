"use client"

import { useState, useEffect, useRef } from "react"
import { Button } from "@/components/ui/button"
import { ActionButton } from "@/components/ui/action-button"
import { Alert } from "@/components/ui/alert"
import { Layout } from "@/components/layout"
import { Header } from "@/components/header"
import { clearAuth, createPost, createNote, updatePost, updateNote, deletePost, deleteNote, getPostContent, getNoteContent } from "@/app/actions/posts"
import { toast } from "sonner"
import { cn } from "@/lib/utils"
import { Loader2, Github } from "lucide-react"
import { PageLoader } from "@/components/ui/loading-spinner"
import { Card } from "@/components/ui/card"
import { SubmitButton } from "@/components/ui/submit-button"
import {
  AdminHeader,
  StatsSection,
  PostForm,
  NoteForm,
  ContentEditor,
} from "@/components/pages/admin"
import { ContentList } from "@/components/pages/admin/content-list"

type ContentType = "post" | "note"
type ViewMode = "edit" | "preview" | "split"

export default function AdminPage() {
  const [isAuthenticated, setIsAuthenticated] = useState<boolean | null>(null)
  const [username, setUsername] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState("")
  const [success, setSuccess] = useState("")
  const [contentType, setContentType] = useState<ContentType>("note")
  const [viewMode, setViewMode] = useState<ViewMode>("split")
  const [showList, setShowList] = useState(false)
  const [editingId, setEditingId] = useState<string | null>(null)
  
  // åˆ›ä½œç»Ÿè®¡æ•°æ®
  const [stats, setStats] = useState<{
    posts: { date: string }[]
    notes: { date: string }[]
    tags: { tag: string; count: number }[]
    stats: {
      totalPosts: number
      totalNotes: number
      thisMonthPosts: number
      thisMonthNotes: number
      thisWeekPosts: number
      thisWeekNotes: number
    }
  } | null>(null)

  // åˆ—è¡¨æ•°æ®
  const [postsList, setPostsList] = useState<Array<{ id: string; title: string; date: string; tags: string[] }>>([])
  const [notesList, setNotesList] = useState<Array<{ id: string; date: string; content: string }>>([])
  const [listLoading, setListLoading] = useState(false)

  // ç”¨äºåŒæ­¥æ»šåŠ¨çš„ ref
  const textareaRef = useRef<HTMLTextAreaElement>(null)
  const previewRef = useRef<HTMLDivElement>(null)
  const isScrollingRef = useRef(false)

  // è·å–å½“å¤©æ—¥æœŸï¼ˆæœ¬åœ°æ—¶é—´ï¼‰
  const getTodayDate = (): string => {
    const today = new Date()
    const year = today.getFullYear()
    const month = String(today.getMonth() + 1).padStart(2, '0')
    const day = String(today.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  }

  // è¡¨å•çŠ¶æ€
  const [formData, setFormData] = useState({
    title: "",
    content: "",
    date: getTodayDate(),
    tags: [] as string[],
    id: "",
  })

  // è®¡ç®—è‡ªåŠ¨ç”Ÿæˆçš„ IDï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
  const getAutoGeneratedId = (): string => {
    if (formData.id && formData.id.trim()) {
      return formData.id.trim().toLowerCase()
    }
    
    if (contentType === "post" && formData.title && formData.title.trim()) {
      const generated = formData.title
        .toLowerCase()
        .replace(/[^\w\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "")
        .trim()
        .substring(0, 50)
      
      if (generated && generated.length > 0) {
        return generated
      }
    }
    
    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ—¥æœŸ + æ—¶é—´æˆ³ + éšæœºåç¼€
    const dateStr = formData.date.replace(/-/g, "")
    const timestamp = Date.now().toString().slice(-8)
    const randomSuffix = Math.random().toString(36).substring(2, 6)
    const prefix = contentType === "post" ? "post" : "note"
    return `${prefix}-${dateStr}-${timestamp}-${randomSuffix}`
  }

  const autoGeneratedId = getAutoGeneratedId()

  // æ£€æŸ¥è®¤è¯çŠ¶æ€å’Œ URL å‚æ•°
  useEffect(() => {
    async function checkAuthStatus() {
      try {
        const response = await fetch("/api/admin/check")
        const data = await response.json()
        setIsAuthenticated(data.authenticated)
        setUsername(data.username || null)
        
        // è®¤è¯æˆåŠŸåï¼Œç¡®ä¿æ—¥æœŸæ˜¯å½“å¤©
        if (data.authenticated) {
          const today = getTodayDate()
          setFormData(prev => ({
            ...prev,
            date: today
          }))
        }
      } catch (error) {
        setIsAuthenticated(false)
      }
    }

    // æ£€æŸ¥ URL å‚æ•°ä¸­çš„é”™è¯¯æˆ–æˆåŠŸæ¶ˆæ¯
    const params = new URLSearchParams(window.location.search)
    const errorParam = params.get("error")
    const successParam = params.get("success")

    if (errorParam) {
      const errorMessage = decodeURIComponent(errorParam)
      setError(errorMessage)
      toast.error(errorMessage)
      window.history.replaceState({}, "", "/admin")
    }

    if (successParam) {
      const successMessage = decodeURIComponent(successParam)
      toast.success(successMessage, {
        duration: 3000,
      })
      window.history.replaceState({}, "", "/admin")
    }

    checkAuthStatus()
  }, [])
  
  // è·å–åˆ›ä½œç»Ÿè®¡æ•°æ®
  const fetchStats = async () => {
    try {
      const response = await fetch("/api/admin/stats")
      if (response.ok) {
        const data = await response.json()
        setStats(data)
      }
    } catch (error) {
      console.error("Failed to fetch stats:", error)
    }
  }

  // è·å–å†…å®¹åˆ—è¡¨
  const fetchContentList = async () => {
    setListLoading(true)
    try {
      if (contentType === "post") {
        const response = await fetch("/api/admin/posts")
        if (response.ok) {
          const data = await response.json()
          setPostsList(data)
        }
      } else {
        const response = await fetch("/api/admin/notes")
        if (response.ok) {
          const data = await response.json()
          setNotesList(data)
        }
      }
    } catch (error) {
      console.error("Failed to fetch content list:", error)
      toast.error("è·å–åˆ—è¡¨å¤±è´¥")
    } finally {
      setListLoading(false)
    }
  }
  
  useEffect(() => {
    if (isAuthenticated) {
      fetchStats()
    }
  }, [isAuthenticated])

  // å½“åˆ‡æ¢å†…å®¹ç±»å‹æˆ–æ˜¾ç¤ºåˆ—è¡¨æ—¶ï¼Œåˆ·æ–°åˆ—è¡¨
  useEffect(() => {
    if (isAuthenticated && showList) {
      fetchContentList()
    }
  }, [isAuthenticated, contentType, showList])

  // å¤„ç† GitHub OAuth ç™»å½•
  function handleGitHubLogin() {
    window.location.href = "/api/auth/github"
  }

  // å¤„ç†ç™»å‡º
  async function handleLogout() {
    await clearAuth()
    setIsAuthenticated(false)
    setUsername(null)
    setSuccess("å·²ç™»å‡º")
  }

  // åˆ‡æ¢å†…å®¹ç±»å‹æ—¶é‡ç½®è¡¨å•
  useEffect(() => {
    if (contentType === "note") {
      const today = getTodayDate()
      setFormData({
        title: "",
        content: formData.content,
        date: today,
        tags: [],
        id: "",
      })
      // éšç¬”æ¨¡å¼ä¸‹è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
      setTimeout(() => {
        textareaRef.current?.focus()
      }, 100)
    }
  }, [contentType])
  
  // éšç¬”æ¨¡å¼ä¸‹ï¼Œé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨èšç„¦
  useEffect(() => {
    if (contentType === "note" && isAuthenticated) {
      setTimeout(() => {
        textareaRef.current?.focus()
      }, 300)
    }
  }, [isAuthenticated, contentType])

  // å¤„ç†ç¼–è¾‘
  const handleEdit = async (id: string) => {
    setLoading(true)
    setError("")
    try {
      if (contentType === "post") {
        const result = await getPostContent(id)
        if (result.success && result.post) {
          setFormData({
            title: result.post.title,
            content: result.post.content,
            date: result.post.date.split("T")[0], // ä» ISO æ ¼å¼æå–æ—¥æœŸéƒ¨åˆ†
            tags: result.post.tags || [],
            id: result.post.id,
          })
          setEditingId(id)
          setShowList(false)
          toast.success("å·²åŠ è½½æ–‡ç« å†…å®¹")
        } else {
          setError(result.message || "åŠ è½½æ–‡ç« å¤±è´¥")
          toast.error(result.message || "åŠ è½½æ–‡ç« å¤±è´¥")
        }
      } else {
        const result = await getNoteContent(id)
        if (result.success && result.note) {
          setFormData({
            title: "",
            content: result.note.content,
            date: result.note.date.split("T")[0], // ä» ISO æ ¼å¼æå–æ—¥æœŸéƒ¨åˆ†
            tags: [],
            id: result.note.id,
          })
          setEditingId(id)
          setShowList(false)
          toast.success("å·²åŠ è½½éšç¬”å†…å®¹")
        } else {
          setError(result.message || "åŠ è½½éšç¬”å¤±è´¥")
          toast.error(result.message || "åŠ è½½éšç¬”å¤±è´¥")
        }
      }
    } catch (err) {
      const errorMessage = "åŠ è½½å†…å®¹å¤±è´¥ï¼Œè¯·é‡è¯•"
      setError(errorMessage)
      toast.error(errorMessage)
    } finally {
      setLoading(false)
    }
  }

  // å¤„ç†åˆ é™¤
  const handleDelete = async (id: string) => {
    try {
      let result
      if (contentType === "post") {
        result = await deletePost(id)
      } else {
        result = await deleteNote(id)
      }

      if (result.success) {
        // åˆ·æ–°åˆ—è¡¨å’Œç»Ÿè®¡æ•°æ®
        fetchContentList()
        fetchStats()
        // å¦‚æœåˆ é™¤çš„æ˜¯æ­£åœ¨ç¼–è¾‘çš„å†…å®¹ï¼Œæ¸…ç©ºè¡¨å•
        if (editingId === id) {
          setFormData({
            title: "",
            content: "",
            date: getTodayDate(),
            tags: [],
            id: "",
          })
          setEditingId(null)
        }
      } else {
        throw new Error(result.message)
      }
    } catch (err) {
      throw err
    }
  }

  // å¤„ç†æäº¤
  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()

    // åŸºæœ¬éªŒè¯
    if (contentType === "post" && !formData.title.trim()) {
      setError("è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜")
      toast.error("è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜")
      return
    }

    if (!formData.content.trim()) {
      setError("è¯·è¾“å…¥å†…å®¹")
      toast.error("è¯·è¾“å…¥å†…å®¹")
      return
    }

    if (!formData.date) {
      setError("è¯·é€‰æ‹©æ—¥æœŸ")
      toast.error("è¯·é€‰æ‹©æ—¥æœŸ")
      return
    }

    setLoading(true)
    setError("")
    setSuccess("")

    try {
      let result
      if (editingId) {
        // æ›´æ–°æ¨¡å¼
        if (contentType === "post") {
          result = await updatePost(editingId, {
            title: formData.title,
            content: formData.content,
            date: formData.date,
            tags: formData.tags,
          })
        } else {
          result = await updateNote(editingId, {
            content: formData.content,
            date: formData.date,
          })
        }
      } else {
        // åˆ›å»ºæ¨¡å¼
        if (contentType === "post") {
          result = await createPost({
            title: formData.title,
            content: formData.content,
            date: formData.date,
            tags: formData.tags,
            id: formData.id || undefined,
          })
        } else {
          result = await createNote({
            content: formData.content,
            date: formData.date,
            id: formData.id || undefined,
          })
        }
      }

      if (result.success) {
        // æ›´æ–°æ¨¡å¼ä¸‹ä½¿ç”¨ editingIdï¼Œåˆ›å»ºæ¨¡å¼ä¸‹ä½¿ç”¨ result.idï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const actualId = editingId || ("id" in result ? result.id : formData.id || autoGeneratedId)
        const successMessage = `${result.message}ã€‚${contentType === "post" ? "æ–‡ç« " : "éšç¬”"}å·²æäº¤åˆ° GitHubï¼ŒVercel å°†è‡ªåŠ¨é‡æ–°éƒ¨ç½²ï¼ˆé€šå¸¸éœ€è¦ 1-2 åˆ†é’Ÿï¼‰`
        const detailMessage = `æ–‡ä»¶ ID: ${actualId}`
        setSuccess(successMessage)
        toast.success(`${successMessage}\n${detailMessage}`, {
          duration: 6000,
        })
        // æ¸…ç©ºè¡¨å•
        setFormData({
          title: "",
          content: "",
          date: getTodayDate(),
          tags: [],
          id: "",
        })
        setEditingId(null)
        // åˆ·æ–°ç»Ÿè®¡æ•°æ®å’Œåˆ—è¡¨
        fetchStats()
        if (showList) {
          fetchContentList()
        }
      } else {
        setError(result.message)
        toast.error(result.message)
      }
    } catch (err) {
      const errorMessage = "æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•"
      setError(errorMessage)
      toast.error(errorMessage)
    } finally {
      setLoading(false)
    }
  }

  // åˆ‡æ¢åˆ°æ–°å»ºæ¨¡å¼
  const handleNew = () => {
    setFormData({
      title: "",
      content: "",
      date: getTodayDate(),
      tags: [],
      id: "",
    })
    setEditingId(null)
    setShowList(false)
  }

  // å¦‚æœè¿˜åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
  if (isAuthenticated === null) {
    return (
      <Layout>
        <div className="max-w-2xl mx-auto px-4 py-6">
          <Header showBackButton={true} />
          <PageLoader
            message="æ­£åœ¨éªŒè¯èº«ä»½..."
            subMessage="ç¨ç­‰ç‰‡åˆ»"
            size="lg"
          />
        </div>
      </Layout>
    )
  }

  // å¦‚æœæœªè®¤è¯ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
  if (!isAuthenticated) {
    return (
      <Layout>
        <div className="max-w-2xl mx-auto px-4 py-6">
          <Header showBackButton={true} />
          <div className="max-w-md mx-auto mt-12">
            <h1 className="text-2xl font-bold mb-4">ä½ å±…ç„¶å‘ç°è¿™é‡Œäº†ï¼ğŸ‰</h1>
            <p className="text-sm text-zinc-600 dark:text-zinc-400 mb-2">
              è¿™é‡Œæ˜¯æˆ‘çš„ç§˜å¯†åŸºåœ°ï¼Œåªæœ‰æˆ‘çŸ¥é“æ€ä¹ˆè¿›æ¥ ğŸ˜
            </p>
            <p className="text-xs text-zinc-500 dark:text-zinc-500 mb-6 italic">
              ä¸è¿‡æ—¢ç„¶ä½ æ‰¾åˆ°äº†ï¼Œé‚£å°±ç”¨ GitHub ç™»å½•è¯•è¯•çœ‹å§ï½
            </p>
            {error && (
              <Alert variant="destructive" className="mb-4">
                {error}
              </Alert>
            )}
            {success && (
              <Alert variant="success" className="mb-4">
                {success}
              </Alert>
            )}
            <ActionButton
              icon={loading ? Loader2 : Github}
              iconClassName={loading ? "animate-spin" : undefined}
              onClick={handleGitHubLogin}
              disabled={loading}
              className="w-full justify-center"
            >
              {loading ? "ç™»å½•ä¸­..." : "ç”¨ GitHub ç™»å½•è¯•è¯•"}
            </ActionButton>
            <p className="mt-4 text-xs text-zinc-500 dark:text-zinc-400 text-center italic">
              æç¤ºï¼šåªæœ‰ä»“åº“æ‰€æœ‰è€…æˆ–åä½œè€…æ‰èƒ½è¿›æ¥å“¦
            </p>
            
            {/* æœ‰è¶£çš„å†…å®¹ */}
            <div className="mt-12 pt-8 border-t border-zinc-200 dark:border-zinc-800">
              <div className="text-center space-y-4">
                <div className="text-4xl mb-4">ğŸ”</div>
                <p className="text-sm text-zinc-500 dark:text-zinc-500 italic">
                  "å¥½å¥‡å¿ƒæ˜¯å‘ç°ç§˜å¯†çš„ç¬¬ä¸€æ­¥"
                </p>
                <div className="flex justify-center gap-2 text-2xl mt-6">
                  <span>ğŸ¨</span>
                  <span>ğŸ’»</span>
                  <span>ğŸ“</span>
                  <span>âœ¨</span>
                </div>
                <p className="text-xs text-zinc-400 dark:text-zinc-600 mt-4">
                  å¦‚æœä½ çœŸçš„è¿›æ¥äº†ï¼Œè®°å¾—å¸®æˆ‘å†™ç‚¹å¥½ä¸œè¥¿ ğŸ˜Š
                </p>
                <Card variant="muted" size="md">
                  <p className="text-xs text-zinc-600 dark:text-zinc-400 leading-relaxed">
                    <span className="font-semibold">å°è´´å£«ï¼š</span>
                    <br />
                    è¿™ä¸ªé¡µé¢æ˜¯æˆ‘ç”¨æ¥ç®¡ç†åšå®¢å†…å®¹çš„ï¼Œå¦‚æœä½ ä¹Ÿæƒ³æ­å»ºç±»ä¼¼çš„åšå®¢ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„ GitHub ä»“åº“æºç å“¦ï½
                  </p>
                </Card>
              </div>
            </div>
          </div>
        </div>
      </Layout>
    )
  }

  // å·²è®¤è¯ï¼Œæ˜¾ç¤ºç®¡ç†ç•Œé¢
  return (
    <Layout>
      <div className="max-w-7xl mx-auto px-4 py-6">
        <Header showBackButton={true} />
        
        <AdminHeader
          username={username}
          contentType={contentType}
          viewMode={viewMode}
          showList={showList}
          onContentTypeChange={(type) => {
            setContentType(type)
            setShowList(false)
            handleNew()
          }}
          onViewModeChange={setViewMode}
          onLogout={handleLogout}
          onToggleList={() => {
            setShowList(!showList)
            if (!showList) {
              fetchContentList()
            }
          }}
        />

        {/* å†…å®¹åˆ—è¡¨è§†å›¾ */}
        {showList ? (
          <div className="bg-transparent">
            <h2 className="text-lg font-semibold mb-4 text-zinc-900 dark:text-zinc-100">
              {contentType === "post" ? "æ–‡ç« åˆ—è¡¨" : "éšç¬”åˆ—è¡¨"}
            </h2>
            <ContentList
              contentType={contentType}
              posts={postsList}
              notes={notesList}
              onEdit={handleEdit}
              onDelete={handleDelete}
              loading={listLoading}
            />
          </div>
        ) : (
          <>
            {/* åˆ›ä½œç»Ÿè®¡åŒºåŸŸ - ä»…åœ¨æ–‡ç« æ¨¡å¼ä¸‹æ˜¾ç¤º */}
            {stats && contentType === "post" && (
              <StatsSection
                stats={stats}
                selectedTags={formData.tags}
                onTagToggle={(tag: string) => {
                  setFormData(prev => ({
                    ...prev,
                    tags: prev.tags.includes(tag)
                      ? prev.tags.filter(t => t !== tag)
                      : [...prev.tags, tag]
                  }))
                }}
                title={formData.title}
                date={formData.date}
                onTitleChange={(title: string) => setFormData(prev => ({ ...prev, title }))}
                onDateChange={(date: string) => setFormData(prev => ({ ...prev, date }))}
                onTagsChange={(tags: string[]) => setFormData(prev => ({ ...prev, tags }))}
              />
            )}

            <form onSubmit={handleSubmit} className={cn("space-y-0", contentType === "note" && "space-y-0")}>
          {/* æ–‡ç« æ¨¡å¼ - æ•´åˆè®¾è®¡ */}
          {contentType === "post" && (
            <div className="bg-transparent dark:bg-transparent rounded-xl overflow-hidden">
              
              {/* å†…å®¹ç¼–è¾‘å’Œé¢„è§ˆ - æ— ç¼è¿æ¥ */}
              <ContentEditor
                content={formData.content}
                viewMode={viewMode}
                onContentChange={(content: string) => setFormData(prev => ({ ...prev, content }))}
              />
              
              {/* æäº¤æŒ‰é’® - æ•´åˆåœ¨åº•éƒ¨ */}
              <div className="flex justify-end items-center gap-3 py-4">
                {editingId && (
                  <Button
                    type="button"
                    variant="outline"
                    onClick={handleNew}
                    className={cn(
                      "h-9 px-6 rounded-xl text-sm font-medium",
                      "bg-white dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700",
                      "text-zinc-700 dark:text-zinc-300",
                      "hover:bg-zinc-50 dark:hover:bg-zinc-700"
                    )}
                  >
                    å–æ¶ˆç¼–è¾‘
                  </Button>
                )}
                <SubmitButton
                  loading={loading}
                  editing={!!editingId}
                  editText="æ›´æ–°æ–‡ç« "
                  createText="å‘å¸ƒæ–‡ç« "
                  editingLoadingText="æ›´æ–°ä¸­..."
                  creatingLoadingText="æäº¤ä¸­..."
                />
              </div>
            </div>
          )}
          
          {/* éšç¬”æ¨¡å¼ */}
          {contentType === "note" && (
            <NoteForm
              content={formData.content}
              date={formData.date}
              autoGeneratedId={autoGeneratedId}
              viewMode={viewMode}
              loading={loading}
              editing={!!editingId}
              onContentChange={(content: string) => setFormData(prev => ({ ...prev, content }))}
              onDateChange={(date: string) => setFormData(prev => ({ ...prev, date }))}
              onViewModeChange={setViewMode}
              onCancelEdit={handleNew}
            />
          )}
        </form>
          </>
        )}
      </div>
    </Layout>
  )
}
