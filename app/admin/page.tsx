"use client"

import { useState, useEffect, useRef } from "react"
import { Button } from "@/components/ui/button"
import { Layout } from "@/components/layout"
import { Header } from "@/components/header"
import { clearAuth, createPost, createNote } from "@/app/actions/posts"
import { Alert } from "@/components/ui/alert"
import { toast } from "sonner"
import { cn } from "@/lib/utils"
import { Loader2 } from "lucide-react"
import {
  AdminHeader,
  StatsSection,
  PostForm,
  NoteForm,
  ContentEditor,
} from "@/components/pages/admin"

type ContentType = "post" | "note"
type ViewMode = "edit" | "preview" | "split"

export default function AdminPage() {
  const [isAuthenticated, setIsAuthenticated] = useState<boolean | null>(null)
  const [username, setUsername] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState("")
  const [success, setSuccess] = useState("")
  const [contentType, setContentType] = useState<ContentType>("note")
  const [viewMode, setViewMode] = useState<ViewMode>("split")
  
  // åˆ›ä½œç»Ÿè®¡æ•°æ®
  const [stats, setStats] = useState<{
    posts: { date: string }[]
    notes: { date: string }[]
    tags: { tag: string; count: number }[]
    stats: {
      totalPosts: number
      totalNotes: number
      thisMonthPosts: number
      thisMonthNotes: number
      thisWeekPosts: number
      thisWeekNotes: number
    }
  } | null>(null)

  // ç”¨äºåŒæ­¥æ»šåŠ¨çš„ ref
  const textareaRef = useRef<HTMLTextAreaElement>(null)
  const previewRef = useRef<HTMLDivElement>(null)
  const isScrollingRef = useRef(false)

  // è·å–å½“å¤©æ—¥æœŸï¼ˆæœ¬åœ°æ—¶é—´ï¼‰
  const getTodayDate = (): string => {
    const today = new Date()
    const year = today.getFullYear()
    const month = String(today.getMonth() + 1).padStart(2, '0')
    const day = String(today.getDate()).padStart(2, '0')
    return `${year}-${month}-${day}`
  }

  // è¡¨å•çŠ¶æ€
  const [formData, setFormData] = useState({
    title: "",
    content: "",
    date: getTodayDate(),
    tags: [] as string[],
    id: "",
  })

  // è®¡ç®—è‡ªåŠ¨ç”Ÿæˆçš„ IDï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
  const getAutoGeneratedId = (): string => {
    if (formData.id && formData.id.trim()) {
      return formData.id.trim().toLowerCase()
    }
    
    if (contentType === "post" && formData.title && formData.title.trim()) {
      const generated = formData.title
        .toLowerCase()
        .replace(/[^\w\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "")
        .trim()
        .substring(0, 50)
      
      if (generated && generated.length > 0) {
        return generated
      }
    }
    
    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ—¥æœŸ + æ—¶é—´æˆ³ + éšæœºåç¼€
    const dateStr = formData.date.replace(/-/g, "")
    const timestamp = Date.now().toString().slice(-8)
    const randomSuffix = Math.random().toString(36).substring(2, 6)
    const prefix = contentType === "post" ? "post" : "note"
    return `${prefix}-${dateStr}-${timestamp}-${randomSuffix}`
  }

  const autoGeneratedId = getAutoGeneratedId()

  // æ£€æŸ¥è®¤è¯çŠ¶æ€å’Œ URL å‚æ•°
  useEffect(() => {
    async function checkAuthStatus() {
      try {
        const response = await fetch("/api/admin/check")
        const data = await response.json()
        setIsAuthenticated(data.authenticated)
        setUsername(data.username || null)
        
        // è®¤è¯æˆåŠŸåï¼Œç¡®ä¿æ—¥æœŸæ˜¯å½“å¤©
        if (data.authenticated) {
          const today = getTodayDate()
          setFormData(prev => ({
            ...prev,
            date: today
          }))
        }
      } catch (error) {
        setIsAuthenticated(false)
      }
    }

    // æ£€æŸ¥ URL å‚æ•°ä¸­çš„é”™è¯¯æˆ–æˆåŠŸæ¶ˆæ¯
    const params = new URLSearchParams(window.location.search)
    const errorParam = params.get("error")
    const successParam = params.get("success")

    if (errorParam) {
      const errorMessage = decodeURIComponent(errorParam)
      setError(errorMessage)
      toast.error(errorMessage)
      window.history.replaceState({}, "", "/admin")
    }

    if (successParam) {
      const successMessage = decodeURIComponent(successParam)
      toast.success(successMessage, {
        duration: 3000,
      })
      window.history.replaceState({}, "", "/admin")
    }

    checkAuthStatus()
  }, [])
  
  // è·å–åˆ›ä½œç»Ÿè®¡æ•°æ®
  const fetchStats = async () => {
    try {
      const response = await fetch("/api/admin/stats")
      if (response.ok) {
        const data = await response.json()
        setStats(data)
      }
    } catch (error) {
      console.error("Failed to fetch stats:", error)
    }
  }
  
  useEffect(() => {
    if (isAuthenticated) {
      fetchStats()
    }
  }, [isAuthenticated])

  // å¤„ç† GitHub OAuth ç™»å½•
  function handleGitHubLogin() {
    window.location.href = "/api/auth/github"
  }

  // å¤„ç†ç™»å‡º
  async function handleLogout() {
    await clearAuth()
    setIsAuthenticated(false)
    setUsername(null)
    setSuccess("å·²ç™»å‡º")
  }

  // åˆ‡æ¢å†…å®¹ç±»å‹æ—¶é‡ç½®è¡¨å•
  useEffect(() => {
    if (contentType === "note") {
      const today = getTodayDate()
      setFormData({
        title: "",
        content: formData.content,
        date: today,
        tags: [],
        id: "",
      })
      // éšç¬”æ¨¡å¼ä¸‹è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
      setTimeout(() => {
        textareaRef.current?.focus()
      }, 100)
    }
  }, [contentType])
  
  // éšç¬”æ¨¡å¼ä¸‹ï¼Œé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨èšç„¦
  useEffect(() => {
    if (contentType === "note" && isAuthenticated) {
      setTimeout(() => {
        textareaRef.current?.focus()
      }, 300)
    }
  }, [isAuthenticated, contentType])

  // å¤„ç†æäº¤
  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()

    // åŸºæœ¬éªŒè¯
    if (contentType === "post" && !formData.title.trim()) {
      setError("è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜")
      toast.error("è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜")
      return
    }

    if (!formData.content.trim()) {
      setError("è¯·è¾“å…¥å†…å®¹")
      toast.error("è¯·è¾“å…¥å†…å®¹")
      return
    }

    if (!formData.date) {
      setError("è¯·é€‰æ‹©æ—¥æœŸ")
      toast.error("è¯·é€‰æ‹©æ—¥æœŸ")
      return
    }

    setLoading(true)
    setError("")
    setSuccess("")

    try {
      let result
      if (contentType === "post") {
        result = await createPost({
          title: formData.title,
          content: formData.content,
          date: formData.date,
          tags: formData.tags,
          id: undefined,
        })
      } else {
        result = await createNote({
          content: formData.content,
          date: formData.date,
          id: undefined,
        })
      }

      if (result.success) {
        const actualId = result.id || autoGeneratedId
        const successMessage = `${result.message}ã€‚${contentType === "post" ? "æ–‡ç« " : "éšç¬”"}å·²æäº¤åˆ° GitHubï¼ŒVercel å°†è‡ªåŠ¨é‡æ–°éƒ¨ç½²ï¼ˆé€šå¸¸éœ€è¦ 1-2 åˆ†é’Ÿï¼‰`
        const detailMessage = `æ–‡ä»¶ ID: ${actualId}`
        setSuccess(successMessage)
        toast.success(`${successMessage}\n${detailMessage}`, {
          duration: 6000,
        })
        // æ¸…ç©ºè¡¨å•
        setFormData({
          title: "",
          content: "",
          date: getTodayDate(),
          tags: [],
          id: "",
        })
        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        fetchStats()
      } else {
        setError(result.message)
        toast.error(result.message)
      }
    } catch (err) {
      const errorMessage = "æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•"
      setError(errorMessage)
      toast.error(errorMessage)
    } finally {
      setLoading(false)
    }
  }

  // å¦‚æœè¿˜åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
  if (isAuthenticated === null) {
    return (
      <Layout>
        <div className="max-w-2xl mx-auto px-4 py-6">
          <Header showBackButton={true} />
          <div className="flex flex-col items-center justify-center min-h-[60vh]">
            <div className="relative">
              <div className="absolute inset-0 bg-gradient-to-r from-zinc-200 to-zinc-300 dark:from-zinc-700 dark:to-zinc-800 rounded-full blur-xl opacity-50 animate-pulse"></div>
              <div className="relative bg-white dark:bg-zinc-900 rounded-full p-6 shadow-lg border border-zinc-200 dark:border-zinc-800">
                <Loader2 className="w-8 h-8 text-zinc-600 dark:text-zinc-400 animate-spin" />
              </div>
            </div>
            <p className="mt-6 text-sm font-medium text-zinc-600 dark:text-zinc-400">
              æ­£åœ¨éªŒè¯èº«ä»½...
            </p>
            <p className="mt-2 text-xs text-zinc-500 dark:text-zinc-500 italic">
              ç¨ç­‰ç‰‡åˆ»
            </p>
          </div>
        </div>
      </Layout>
    )
  }

  // å¦‚æœæœªè®¤è¯ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
  if (!isAuthenticated) {
    return (
      <Layout>
        <div className="max-w-2xl mx-auto px-4 py-6">
          <Header showBackButton={true} />
          <div className="max-w-md mx-auto mt-12">
            <h1 className="text-2xl font-bold mb-4">ä½ å±…ç„¶å‘ç°è¿™é‡Œäº†ï¼ğŸ‰</h1>
            <p className="text-sm text-zinc-600 dark:text-zinc-400 mb-2">
              è¿™é‡Œæ˜¯æˆ‘çš„ç§˜å¯†åŸºåœ°ï¼Œåªæœ‰æˆ‘çŸ¥é“æ€ä¹ˆè¿›æ¥ ğŸ˜
            </p>
            <p className="text-xs text-zinc-500 dark:text-zinc-500 mb-6 italic">
              ä¸è¿‡æ—¢ç„¶ä½ æ‰¾åˆ°äº†ï¼Œé‚£å°±ç”¨ GitHub ç™»å½•è¯•è¯•çœ‹å§ï½
            </p>
            {error && (
              <div className="mb-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md text-red-700 dark:text-red-400 text-sm">
                {error}
              </div>
            )}
            {success && (
              <div className="mb-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md text-green-700 dark:text-green-400 text-sm">
                {success}
              </div>
            )}
            <Button
              onClick={handleGitHubLogin}
              disabled={loading}
              className="w-full"
            >
              {loading ? "ç™»å½•ä¸­..." : "ç”¨ GitHub ç™»å½•è¯•è¯•"}
            </Button>
            <p className="mt-4 text-xs text-zinc-500 dark:text-zinc-400 text-center italic">
              æç¤ºï¼šåªæœ‰ä»“åº“æ‰€æœ‰è€…æˆ–åä½œè€…æ‰èƒ½è¿›æ¥å“¦
            </p>
            
            {/* æœ‰è¶£çš„å†…å®¹ */}
            <div className="mt-12 pt-8 border-t border-zinc-200 dark:border-zinc-800">
              <div className="text-center space-y-4">
                <div className="text-4xl mb-4">ğŸ”</div>
                <p className="text-sm text-zinc-500 dark:text-zinc-500 italic">
                  "å¥½å¥‡å¿ƒæ˜¯å‘ç°ç§˜å¯†çš„ç¬¬ä¸€æ­¥"
                </p>
                <div className="flex justify-center gap-2 text-2xl mt-6">
                  <span>ğŸ¨</span>
                  <span>ğŸ’»</span>
                  <span>ğŸ“</span>
                  <span>âœ¨</span>
                </div>
                <p className="text-xs text-zinc-400 dark:text-zinc-600 mt-4">
                  å¦‚æœä½ çœŸçš„è¿›æ¥äº†ï¼Œè®°å¾—å¸®æˆ‘å†™ç‚¹å¥½ä¸œè¥¿ ğŸ˜Š
                </p>
                <div className="mt-6 p-4 bg-zinc-50 dark:bg-zinc-900/30 rounded-lg border border-zinc-200 dark:border-zinc-800">
                  <p className="text-xs text-zinc-600 dark:text-zinc-400 leading-relaxed">
                    <span className="font-semibold">å°è´´å£«ï¼š</span>
                    <br />
                    è¿™ä¸ªé¡µé¢æ˜¯æˆ‘ç”¨æ¥ç®¡ç†åšå®¢å†…å®¹çš„ï¼Œå¦‚æœä½ ä¹Ÿæƒ³æ­å»ºç±»ä¼¼çš„åšå®¢ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„ GitHub ä»“åº“æºç å“¦ï½
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </Layout>
    )
  }

  // å·²è®¤è¯ï¼Œæ˜¾ç¤ºç®¡ç†ç•Œé¢
  return (
    <Layout>
      <div className="max-w-7xl mx-auto px-4 py-6">
        <Header showBackButton={true} />
        
        <AdminHeader
          username={username}
          contentType={contentType}
          viewMode={viewMode}
          onContentTypeChange={setContentType}
          onViewModeChange={setViewMode}
          onLogout={handleLogout}
        />

        {/* æ¶ˆæ¯æç¤º */}
        {error && (
          <Alert
            variant="destructive"
            onClose={() => setError("")}
            autoClose={true}
            autoCloseDelay={8000}
            className="mb-4"
          >
            {error}
          </Alert>
        )}

        {success && (
          <Alert
            variant="success"
            onClose={() => setSuccess("")}
            autoClose={true}
            autoCloseDelay={10000}
            className="mb-4"
          >
            {success}
          </Alert>
        )}

        {/* åˆ›ä½œç»Ÿè®¡åŒºåŸŸ - ä»…åœ¨æ–‡ç« æ¨¡å¼ä¸‹æ˜¾ç¤º */}
        {stats && contentType === "post" && (
          <StatsSection
            stats={stats}
            selectedTags={formData.tags}
            onTagToggle={(tag: string) => {
              setFormData(prev => ({
                ...prev,
                tags: prev.tags.includes(tag)
                  ? prev.tags.filter(t => t !== tag)
                  : [...prev.tags, tag]
              }))
            }}
            title={formData.title}
            date={formData.date}
            onTitleChange={(title: string) => setFormData(prev => ({ ...prev, title }))}
            onDateChange={(date: string) => setFormData(prev => ({ ...prev, date }))}
            onTagsChange={(tags: string[]) => setFormData(prev => ({ ...prev, tags }))}
          />
        )}

        <form onSubmit={handleSubmit} className={cn("space-y-0", contentType === "note" && "space-y-0")}>
          {/* æ–‡ç« æ¨¡å¼ - æ•´åˆè®¾è®¡ */}
          {contentType === "post" && (
            <div className="bg-transparent dark:bg-transparent rounded-xl overflow-hidden">
              
              {/* å†…å®¹ç¼–è¾‘å’Œé¢„è§ˆ - æ— ç¼è¿æ¥ */}
              <ContentEditor
                content={formData.content}
                viewMode={viewMode}
                onContentChange={(content: string) => setFormData(prev => ({ ...prev, content }))}
              />
              
              {/* æäº¤æŒ‰é’® - æ•´åˆåœ¨åº•éƒ¨ */}
              <div className="flex justify-end py-4">
                <Button 
                  type="submit" 
                  disabled={loading} 
                  className={cn(
                    "h-9 px-6 rounded-xl text-sm font-medium",
                    "bg-zinc-900 text-white dark:bg-zinc-50 dark:text-zinc-900",
                    "border border-zinc-900 dark:border-zinc-50",
                    "shadow-sm hover:shadow-md transition-all",
                    "disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-sm"
                  )}
                >
                  {loading ? (
                    <span className="flex items-center gap-2">
                      <Loader2 className="w-4 h-4 animate-spin" />
                      æäº¤ä¸­...
                    </span>
                ) : (
                  "å‘å¸ƒæ–‡ç« "
                )}
                </Button>
              </div>
            </div>
          )}
          
          {/* éšç¬”æ¨¡å¼ */}
          {contentType === "note" && (
            <NoteForm
              content={formData.content}
              date={formData.date}
              autoGeneratedId={autoGeneratedId}
              viewMode={viewMode}
              loading={loading}
              onContentChange={(content: string) => setFormData(prev => ({ ...prev, content }))}
              onDateChange={(date: string) => setFormData(prev => ({ ...prev, date }))}
              onViewModeChange={setViewMode}
            />
          )}
        </form>
      </div>
    </Layout>
  )
}
